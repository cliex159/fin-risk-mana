# (PART) Chapter 2 Univariate Volatility {.unnumbered}

# Stationary processes

The volatility plays a crucial role in financial risk management, it is
the main measure of risk. On the other hands, the volatility is the
key factor in, e.g., Investment decisions, Portfolio construction
(Markowitz model) and Derivative pricing (Black-Scholes model).

* In this Chapter we focus on the estimation and forecasting of
volatility for a single asset (univariate).
* The volatility plays a crucial role in financial risk management, it is
the main measure of risk. On the other hands, the volatility is the
key factor in, e.g., Investment decisions, Portfolio construction
(Markowitz model) and Derivative pricing (Black-Scholes model).
* In this Chapter we focus on the estimation and forecasting of
volatility for a single asset (univariate).

## Time series

* A time series is a sequence of observations in chronological order. For example: daily log returns on a stock or monthly values of the Consumer Price Index (CPI).
* A stochastic process is a sequence of random variables and can be viewed as the “theoretical” or “population” analog of a time series, conversely, a time series can be considered a sample from a stochastic process.
* Denote $\{X_t, t \in I\}$ the time series, where I is a time index. For example: $I = \{1, 2, 3, ...\}$ or $I = \{2000, 2001, 2002...2021\}$. Equally spaced time series are the most common in practice. This is the case of
$I = \{t_1, t_2, ..., t_n\}$, where
$(\Delta = t_{i+1} − t)_i$ with $\Delta$ is a constant.

### Remark

**Difference from traditional Statistical Inference**

* In traditional statistic inference, the data is assumed to be an i.i.d
process (random sample).
* In time series, we do not need this assumption and wish to model the dependency among observations which leads to the concept of autocorrelation.

**Some main problems in time series**

* Formulate and estimate a parametric model for $X_t$ (need to propose methods of estimation and model diagnostics).
* This point is related to the estimation of autoregressive (AR) or ARMA models.
* Estimation of Missing values (fill“gaps”).
* Prediction or Forecasting (“would like to know what a future value is”). For example our data is $x_1, x_2, ..., x_{100}$, we wish to forecast the next 10 values, $x_{101}, ..., x_{110}$. In this case, our forecasting horizon is 10.
* Plotting time series to observe fluctuations of time series, e.g., to find stationarity or non-stationarity, cycles, trends, outliers or interventions. Assisting in the formulation of a parametric model.

### Example {.unnumbered}

Consider Financial Index SP500. The data consists of excess returns $X_t = \ln(S_t) −\ln(S_{t−1})$. From the plot we see the following properties of $X_t$:

```{r,message=FALSE,warning=FALSE}
library(tidyverse)
sp500 = read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vT4WqdVoUIiaMcd4jQj5by3Oauc6G4EFq9VDDrpzG2oBn6TFzyNE1yPV2fKRal5F7DmRzCtVa4nSQIw/pub?gid=279168786&single=true&output=csv")

sp500$Close %>% 
  log %>% 
  diff %>% 
  plot(type = "l",col = "blue")
```

* The mean level of the process seems constant.
* There are sections of the data with explosive behavior (high volatility).
* The data corresponds to a non-stationary process (will define more detailed).
* The variance (or volatility) is not constant in time.
* No linear time series model will be available for this data.

## Autocovariance

### Definition

The autocovariance function a stochastic process $X$ is defined as 
$$\gamma(t,\tau)=\mathbb{E}(X_t −\mu_t)(X_{t−\tau} −\mu_{t−\tau})$$
for $\tau \in \mathbb{Z}$, where $\mu_t = E(X_t)$.

* The autocovariance function is symmetric, i.e., $\gamma(t,\tau) = \gamma(t − \tau,−\tau)$. For special case $\tau = 0$ then $\gamma(t, 0) = Var(X_t)$.
* In general $\gamma(t,\tau)$ is depend on t as well as $\tau$.

### Example {.unnumbered}

Find the autocovariance function of Brownian motion?

>$$\begin{align*}
&B_t \sim \mathcal{N}(0,t) \\
&\rightarrow E[B_t^2] =Var(B_t)=t
\end{align*}$$

>$$\begin{align*}
&B_t-B_{t-\tau} \sim \mathcal{N}(0,t-\tau) \\
&\rightarrow E[(B_t-B_{t-\tau})^2]=Var(B_t-B_{t-\tau})=t-\tau
\end{align*}$$

>$$\begin{align*}
\gamma(t,\tau)&=E[(B_t-\mu_t)(B_{t-\tau}-\mu_{t-\tau})] \\
&=E[B_tB_{t-\tau}] \\
&=-\frac{1}{2}E[(B_t-B_{t-\tau})^2-B_t^2-B_{t-\tau}^2] \\
&=-\frac{1}{2}\{E[(B_t-B_{t-\tau})^2] -E[B_t^2]-E[B_{t-\tau}^2]\} \\
&=-\frac{1}{2} [(\tau)-(t)-(t-\tau)]=t-\tau
\end{align*}$$

>Answer: The autocovariance function of Brownian motion is $t-\tau$.

##  Stationary

### Strictly Stationary

A process is said to be strictly stationary if all aspects of its behavior are unchanged by shifts in time. Mathematically, stationarity is defined as the requirement that for every $m$ and $n$ the distribution of
$(X_1, X_2, ..., X_n)$ and $(X_{1+m}, X_{2+m}, ..., X_{n+m})$ are the same.

### Weakly Stationary

A process is weakly stationary if its mean, variance, and covariance are unchanged by time shifts. More precisely, $X_1, X_2, ...,$ is a weakly stationary process if

1. $\mathbb{E}(X_t)=\mu, \forall t$
2. $Var(X_t) = \sigma_2$ (a positive finite constant) for all $t$.
3. $Cov(X_t, X_s) = \gamma(|t − s|), \forall t, s$ and some function $\gamma$.

We see that, the mean and variance do not change with time and the covariance between two observations depends only on the lag, the time distance $|t − s|$.

* The function $\gamma$ is the autocovariance function of the process and has symmetric property $\gamma(h) = \gamma(−h)$.

$$\begin{align*}
\gamma(h)=cov(X_t,X_{t+h}) \\
\rightarrow \gamma(-h)=cov(X_{t},X_{t-h})
\end{align*}$$

Let $s=t-h$ then $t=s+h$
$$\gamma(-h)=cov(X_{s+h},X_{s})=\gamma(h) $$

* The correlation between $X_t$ and $X_{t+h}$ is denoted by $\rho(h)$. Function $\rho$ is called autocorrelation function (ACF). We have $\gamma(0) = \sigma^2$ and, hence
$\gamma(h) = \sigma^2 \rho(h)$ hence $\rho(h) = \frac{\gamma(h)}{\gamma(0)}$.

The ACF is normalized on $[−1, 1]$. Since the process is required to be covariance stationary, the ACF depends only on one parameter, lag $h$.

### Example {.unnumbered}

Consider the random walk $X: X_t = c + X_{t−1} + \epsilon_t$, with c is constant and white noise $\epsilon_t$. We see that if $c \neq 0$, then $Z_t := X_t −X_{t−1} = c+ \epsilon_t$ have a non-zero mean. We call it a random walk with drift. Note that since $\epsilon_t$ is independent then we call $X_t$ a random walk with independent increments. For more convenience, assume that $c$ and $X_0$ are set to zero. We have 

$$\begin{align*}
&X_t =\epsilon_t + \epsilon_{t−1} +...+\epsilon_1 \\
\\
&\mu_t =E(X_t)=0 \\
\\
&Var(X_t) = t\sigma
\end{align*}$$

$Var(X_t)$ is not stationary but rather increases linearly with time and makes the random walk “wander”, i.e., $X_t$ takes increasingly longer excursions away from its conditional mean of $0$, and therefore is not mean-reverting.

If $s<t$ then

$$ \rho(t,s)=\sqrt{1-\frac{s}{t}} $$

which against $\rho$ depending on $t$ as well as on $s$, thus the random walk is not covariance stationary. The following figure shows the relationship among different processes: Stationary processes are the largest set, followed by white noise, martingale difference (MD), and i.i.d. processes.

<center>
<img src="https://raw.githubusercontent.com/ThanhDatIU/frisk2/main/21.png" alt="" width="50%" height="50%">
</center>

## Estimating Parameters

Let $X_1, X_2, ..., X_n$ be observations from weakly stationary process. To estimate the autocovariance function, we use the sample autocovariance function defined by

$$ \hat{\gamma}(h)=\frac{1}{n} \sum_{t=1}^{n-h}(X_{t+h}-\bar X)(X-t-\bar X) $$

To estimate function $\rho$, we use the sample autocorrelation function
(sample ACF) defined as

$$\hat \rho(h) =\frac{\hat \gamma(h)}{\hat \gamma(h)}$$

* To visualize the dependencies of $x_t$ for different lags h, we use the Correlogram.
* A correlogram is a plot of $h$ (x-axis) versus its corresponding value of $\hat \rho(h)$ (y-axis).
* The correlogram may exhibit patterns and different degrees of dependency in a time series.
* A “band” of size $\frac{2}{\sqrt{n}}$ is added to the correlogram because asymptotically $\hat \rho(h) \sim \mathcal{N} \left(0, \frac{1}{n} \right)$ if the data is close to a white noise process.
* This band is used to detect significant autocorrelations, i.e. autocorelations that are different from zero.

```{r,message=FALSE,warning=FALSE}
library(tidyquant)
msft = tq_get('MSFT',from=as.Date("2010-01-01"),
               to=as.Date("2014-01-01"),
               get = "stock.prices")

msft_logret=msft$adjusted %>% 
  log() %>% 
  diff()

acf(msft_logret,lag.max=10)
```

## The ADF Test

ADF Test is also called Unit Root Test. The test uses the following null and alternative hypotheses:

* $H_0$ : The time series contains a unit root. This means that the time series is non-stationary, i.e., it has some time-dependent structure and does not have constant variance over time.
* $H_1$ : The time series is stationary.

```{r,warning=FALSE,message=FALSE}
library(tseries)
adf.test(msft_logret)
```

## KPSS test

The ideas of KPSS test comes from the regression model with time
  trend

$X_t =c+ \mu_t+k \sum_{i=1}^{t} \xi_i +\eta_t$

with stationary $\eta_t$ and i.i.d $\xi$ with mean $0$ and variance $1$. Note that the third term is a random walk. So we set the null hypothesis: the data is stationary and.

$$ H_0 : k = 0 \\
H_1 : k \neq 0 $$

Test results for Microsoft data

```{r,message=FALSE,warning=FALSE}
library(tseries)
kpss.test(msft_logret)
```

##  Ljung–Box Test

Sample ACF with test bounds.

* These bounds are used to test the null hypothesis that an autocorrelation coefficient is $0$. 
* The null hypothesis is rejected if the sample autocorrelation is outside the bounds.
* The usual level of the test is $0.05$.

### Example {.unnumbered}

(The First-order Autoregression Model (AR(1))) The time series $X = (X_t)$ is called AR(1) if the value of X at time t is a linear function of the value of $X$ at time $t − 1$ as follows

$$X_t=\delta+\phi_1 X_{t-1}+w_t=\delta+\sum_{h=0}^\infty \phi_1^h w_{t-h} $$

1. The errors $w_t \sim \mathcal{N}(0,\sigma_w^2)$ are i.i.d.
2. $w_t$ is independent of $X_t$.
3. $\phi_1<1$. This condition guarantees that $X_t$ is weakly stationary.

$$\begin{align*} 
&\mu=\mathbb{E}(X_t)=\frac{\delta}{1-\phi_1} \\
\\
&Var(X_t)=\frac{\sigma_w^2}{1-\phi_1^2} \\
\\
&Cov(X_t,X_{t+h})=\gamma(h)=\phi_1^h \cdot \frac{\sigma_w^2}{1-\phi_1^2} \\
\\
&\rho(h)=\phi_1^h
\end{align*}$$

Note that the magnitude of its ACF decays geometrically to zero, either slowly as when $\phi_1 = 0.95$, moderately slowly as when $\phi_1 = 0.75$, or rapidly as when $\phi_1 = 0.25$. We now simulate AR(1) and plot the ACF with $\phi_1 =0.64$ and $\sigma_w^2 =1$.

```{r,message=FALSE,warning=FALSE}
library(stats)
ts.sim = arima.sim(list(order = c(1,0,0), ar = 0.64), n = 100,sd=1)
plot(ts.sim,col="blue")
acf(ts.sim)
```

The null hypothesis of the Ljung–Box test is
$$H_0 :\rho(1)=\rho(2)=...\rho(m)=0$$
for some m. If the Ljung–Box test rejects, then we conclude that one or more of $\rho(1), \rho(2), ..., \rho(m)$ is nonzero. The Ljung–Box test is sometimes called simply the Box test.
$$Q(m)=n(n+2) \sum_{i=j}^m \frac{\hat p^2 (j)}{n-j} \sim \chi^2(m)$$

### Example {.unnumbered}

Consider AR(1) with $\phi_1 = 0.64$ and $\sigma_w^2 = 1$, we have the results of Box test in R

```{r,message=FALSE,warning=FALSE}
library(stats)
ts.sim = arima.sim(list(order = c(1,0,0), ar = 0.64), n = 100,sd=1)
plot(ts.sim,col="blue")
Box.test(ts.sim, lag = 10, type = "Ljung-Box")
```

If $|\phi_1| \geq 1$ then AR(1) process is nonstationary, and the mean, variance, covariances and and correlations are not constant.

##  PACF

A partial correlation is a conditional correlation. It is the correlation between two variables under the assumption that we know and take into account the values of some other set of variables.

### Example {.unnumbered}

Consider regression model in which $y$ is the response variable, $x_1, x_2, x_3$ are predictor variables. The partial correlation between y and $x_3$ is the correlation between the variables determined taking into account how both $y$ and $x_3$ are related to $x_1$ and $x_2$.

In regression, this partial correlation could be found by correlating the residuals from two different regressions:

1. Regression in which we predict $y$ from $x_1$ and $x_2$. 
2. Regression in which we predict $x_3$ from $x_1$ and $x_2$.

We correlate the “parts” of $y$ and $x_3$ that are not predicted by $x_1$ and $x_2$. We can define the partial correlation just described as
$$\frac{Cov(y, x_3 | x_1, x_2)}{\sqrt{Var(y | x_1, x_2)Var(x_3 | x_1, x_2)}}$$

For a time series, the partial autocorrelation between $x_t$ and $x_{t−h}$ is defined as the conditional correlation between $x_t$ and $x_{t−h}$ conditional on $x_{t−h+1}, ..., x_{t−1}$, the set of observations that come between the time points $t$ and $t − h$.

$$\frac{Cov(y, x_3 | x_1, x_2)}{\sqrt{Var(y | x_1, x_2)Var(x_3 | x_1, x_2)}}$$

### Example {.unnumbered}

The 3rd order (lag) partial autocorrelation is:

$$\frac{Cov(x_t, x_{t-3} | x_{t-1}, x_{t-2})}{\sqrt{Var(x_t | x_t, x_{t-3})Var(x_{t-3} | x_t, x_{t-3})}}$$

# EWMA

Denote $y_t$ the return of stock at time $t$. Then

* Volatility a weighted sum of past returns, with weights $\omega_i$, is
defined by
$$ \hat \sigma_t^2=\omega_1y_{t-1}^2+\omega_2y_{t-2}^2+...+\omega_Ly_{t-L}^2 $$
where L is the length of the estimation window, i.e., the number of observations used in the calculation. This is called MA model.
* An extension of MA model is Exponentially weighted moving average. Let the weights be exponentially declining, and denote them by $\lambda^i$
$$ \hat \sigma_t^2=\lambda y_{t-1}^2+\lambda^2 y_{t-2}^2+...+\lambda^L y_{t-L}^2 $$
where $0 < \lambda < 1$. If $L$ is large enough, the term αn are negligible for all $n > L$. So we set $L = \infty$.
* Note that the sum of weights is
$$\frac{\lambda}{1-\lambda}=\sum_{i=1}^\infty \lambda^i$$
So the exponentially weighted moving average is defined by
$$ \hat \sigma_t^2=\frac{1-\lambda}{\lambda} \sum_{i=1}^{\infty}\lambda^i y_{t-i}^2 $$
and, hence, we get the EWMA equation (why???)
$$ \hat \sigma_t^2=\lambda \hat \sigma_{t-1}^2+(1-\lambda)y_{t-1}^2 $$
* Note that JP Morgan set for daily data with $\lambda = 0.94$.

## Example {.unnumbered}

Suppose that $\lambda = 0.9$, the volatility estimated for a market variable for
day $n − 1$ is $1\%$ per day, and during day $n − 1$ the market variable
increased by $2\%$. This means that $\sigma_{n-1}^2=0.01^2=0.0001$ and $y_{n-1}^2=0.02^2=0.0004$. From equation (1) we get
$$\sigma_n^2=0.9 \cdot 0.0001 + 0.1 \cdot 0.0004=0.00013 $$
The estimate of the volatility for day $n$ is $\sigma_n = \sqrt{0.00013} = 1.4\%$ per
   day. Note that the expected value of $y_{n-1}^2$ is $\sigma_{n-1}^2= 0.0001$. Hence, realized value of $y_{n−1}^2 = 0.0002$ is greater that expected value, and as a
result our volatility estimate increase. If the realized value of $y_{n−1}^2$ has been less than its expected valued, our estimate of the volatility would have decreased.

# ARCH and GARCH

## ARCH

* The ARCH model was proposed by Robert Engle in 1982 called autoregressive conditionally heteroscadastic.
* Most volatility models derive from this.
* Returns are assumed to have conditional distribution (here
assumed to be normal)
$$y_t \sim \mathcal{N} (0,\sigma_t^2)$$
or we can write
$$y_t=\sigma_t \epsilon_t $$
where $\epsilon_t \sim \mathcal{N}(0, 1)$ is called residual.

ARCH(L1) is defined by
$$Var(y_t | y_{t−1}, y_{t−2}, ..., y_{t−L_1} ) = \sigma_t^2 = \omega + \sum_{i=1}^{L_1} \alpha_i y_{t−i}^2$$
where $L_1$ is called the lag of the model. It is seen that in the ARCH model, the volatility is weighted average of past returns.  

The most common form is ARCH (1)
$$Var(y_t | y_{t−1}) = \sigma_t^2 = \omega + \alpha y_{t−1}^2$$
where $\omega$ and $\alpha$ are parameters that can be estimated by maximum likelihood.

If we assume that the series has $mean = 0$ (this can always be done by centering), then the ARCH model could be written as
$$\begin{align*}
&y_t = \sigma_t \epsilon_t \\
&\sigma_t=\sqrt{\omega+\alpha y_{t-1}^2} \\
&\epsilon_t \sim \mathcal{N}(0,1),i.i.d
\end{align*}$$

We require that $\omega,\alpha>0$ so that $\omega+\alpha y_{t-1}^2>0, \forall t$. We also require that $\alpha < 1$ in order to the process to be stationary with a finite variance. Now we have
$$y_t^2 =\epsilon_t^2(\omega+\alpha y_{t−1}^2)$$
which is similar to an AR(1) for variable $y_t^2$ and with multiplicative noise with a mean of $1$ rather than additive noise with a mean of $0$.

## GARCH

* It turns out that ARCH model is not a very good model and almost nobody uses it. Because, it needs to use information from many days before t to calculate volatility on day t. That is, it needs a lot of lags.
* The $GARCH(L_1, L_2)$ model is defines as
$$ \sigma_t^2=\omega+\sum_{i=1}^{L_1} \alpha_i y_{t-i}^2 + \sum_{i=1}^{L_2} \beta_i \sigma_{t-i}^2 $$ 
and, hence, $GARCH(1,1)$
$$ \sigma_t^2=\omega+\alpha y_{t-1}^2+\beta \sigma_{t-1}^2 $$
* $GARCH(1,1)$ is the most common specification.

### Unconditional volatility

* The unconditional volatility (so-called the long-run variance rate) is the unconditional expectation of volatility on given time
$$\sigma^2=\mathbb{E}(\sigma_t^2) $$
so we have
$$ \sigma^2=\mathbb{E}(\omega+\alpha y_{t-1}^2+\beta \sigma_{t-1}^2)=\omega +\alpha \sigma^2+\beta \sigma^2 $$
Hence,
$$ \sigma^2=\frac{\omega}{1-\alpha-\beta} $$
* So to ensure positive volatility forecasts we need the condition $\omega, \alpha, \beta \geq 0$
Because if any parameter is negative $\sigma_{t+1}$ may be negative.
* For stationary we need condition $\alpha+\beta<1$
Setting $\gamma := 1 − \alpha − \beta$ and $V := \sigma^2$ (called long-run variance rate). We have
$$ \sigma_t^2=\gamma V+\alpha y_{t-1}^2+\beta \sigma_{t-1}^2 $$

### Meaning of Parameters

* The parameter $\alpha$ is news, it shows that how the volatility reacts to new information.
* The parameter $\beta$ is memory, it shows that how much volatility remembers from the past.
* The sum $\alpha + \beta$ determines how quickly the predictability (memory) of the process dies out:
<ul>
<li> if $\alpha + \beta \approx 0$ predictability will die out very quickly.</li> 
<li> if $\alpha + \beta \approx 1$ predictability will die out very slowly.</li>
</ul>

#### Example {.unnumbered}

Suppose that a $GARCH(1,1)$ model is estimated from daily data is 
$$\sigma_n =0.000002+0.13y_{n-1}^2 +0.86 \sigma_{n-1}^2$$
This corresponds to $\omega = 0.000002, \alpha = 0.13, \beta = 0.86$. We have
$$\sigma^2 = \frac{\omega}{1-\alpha-\beta}= 0.0002$$
or $\sigma=\sqrt{0.0002}=0.014=1.4\%$ per day.  

Suppose that the estimate of the volatility on day $n − 1$ is $1.6\%$ per day
so that $\sigma^2 = 0.0162 = 0.000256$, and on that day $n − 1$ the market
variable decreased by $1\%$ so that $y_{n−1}^2 = 0.01^2 = 0.0001$. Then
$$\sigma_n^2 = 0.000002 + 0.13 × 0.0001 + 0.86 × 0.000256 = 0.00023516$$
the new estimate of the volatility is: $\sqrt{0.00023516} = 0.0153$ or $1.53\%$ per day.

# Maximum likelihood

Maximum likelihood is the most important and widespread method of estimation. What is maximum likelihood?

Ask the question which parameters most likely generated the data we have. Suppose we have a sample of $\{−0.2, 3, 4, −1, 0.5\}$. In the following three possibilities, which is most likely for parameters?

```{r, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl = "
| case | $μ$ | $σ$ |
|------|:-----:|---------:|
| 1 | 1 | 5 |
| 2 | -2 | 2 |
| 3 | 1 | 2 |
"
cat(tabl)
```

Let $Y = (y_1,y_2,...,y_n)$ be a vector of data and let $\theta = (\theta_1,\theta_2,...,\theta_p)$ be a vector of parameters. Let $f(Y | \theta)$ be the density of Y which depends on the parameters. The function
$$L(\theta) := f(Y | \theta)$$
is viewed as the function of $\theta$ with $Y$ fixed at the observed data is called
the likelihood function.

* The maximum likelihood estimator (MLE) is the value of $\theta$ that maximizes the likelihood function. We denote the MLE by $\hat \theta_{ML}$.
* It is mathematically easier to maximize $\ln L(\theta)$, which is called the log-likelihood. If the data are independent, then the likelihood is the product of the marginal densities.

## Application to ARCH(1)

Consider ARCH(1) model:

$$\epsilon_t ∼ N(0,1)$$

For $t = 2$ we have the density??

$$ f(y_2|y_1)=\frac{1}{\sqrt{2\pi(\omega+\alpha y_1^2)}} e^{-\frac{1}{2} \frac{y_2^2}{2\omega+\alpha y_1^2}} $$
Hence, the joint density
$$ \prod_{t=2}^T f(y_t|y_{t-1})=\prod_{t=2}^T \frac{1}{\sqrt{2\pi(\omega+\alpha y_{t-1}^2)}} e^{-\frac{1}{2} \frac{y_t^2}{2\omega+\alpha y_{t-1}^2}} $$
and, the log likelihood
$$ \ln(L(\omega, \alpha)) =-\frac{T-1}{2} \ln(2\pi)-\frac{1}{2} \sum_{t=2}^T \left( \ln(\omega+\alpha y_{t-1}^2) + \frac{y_t^2}{\omega+\alpha y_{t-1}^2} \right) $$

##  Application to GARCH(1,1)

$$ \sigma_t^2=\omega+\alpha y_{t-1}^2 +\beta \sigma_{t-1}^2$$
Hence, the joint density
$$ f(y_2|y_1)=\frac{1}{\sqrt{2\pi(\omega+\alpha y_1^2+\beta \hat \sigma_1^2)}} e^{-\frac{1}{2} \frac{y_2^2}{\omega +\alpha y_1^2+\beta \hat \sigma_1^2}} $$
and, the log likelihood
$$ \ln(L(\omega, \alpha)) =-\frac{T-1}{2} \ln(2\pi)-\frac{1}{2} \sum_{t=2}^T \left( \ln(\omega+\alpha y_{t-1}^2+\beta \hat \sigma_{t-1}^2) + \frac{y_t^2}{\omega+\alpha y_{t-1}^2+\beta \hat \sigma_{t-1}^2} \right) $$

### The importance of σ1

* $\sigma_1$ can make a large difference.
* Especially when the sample size is small. 
* Typically set $\sigma_1 = \hat \sigma$.

### Volatility targeting {.unnumbered}

* Since we have the long-run variance rate 
$$\sigma^2= \frac{\omega}{1-\alpha-\beta}$$.
* We can set
$$ \omega=\hat \sigma^2(1-\alpha-\beta) $$
where $\hat \sigma^2$ is is the sample variance.
* Hence we save one parameter in the estimation.

# Future volatility

The variance rate estimated at the end of day $n − 1$ for $n$ day when apply $GARCH(1,1)$ model is

$$ \sigma_n^2=\omega+\alpha y_{n-1}^2+\beta \sigma_{n-1}^2=\sigma^2(1-\alpha-\beta)+\alpha y_{n-1}^2+\beta \sigma_{n-1}^2 $$
or
$$ \sigma_n^2- \sigma^2=\alpha (y_{n-1}^2-\sigma^2)+\beta (\sigma_{n-1}^2-\sigma^2) $$
On day $n+t$ in the future we have
$$ \sigma_{n+t}^2 - \sigma^2=\alpha (y_{n+t-1}^2-\sigma^2)+\beta(\sigma_{n+t-1}^2-\sigma^2) $$
Hence,
$$ \mathbb{E}[\sigma_{n+t}^2 - \sigma^2]=(\alpha+\beta)\mathbb{E}[\sigma_{n+t-1}^2 - \sigma^2] $$
By induction we obtain
$$ \mathbb{E}(\sigma_{n+t}^2) = \sigma^2 + (\alpha + \beta)^t(\sigma_n^2 − \sigma^2) $$

## Example {.unnumbered}

For the S&P data consider earlier, $\alpha + \beta = 0.9935$, the log-run variance rate $\sigma^2 = 0.0002075$ (or $\sigma = 1.44\%$ per day). Suppose that our estimate of the current variance rate per day is $0.0003$ (This corresponds to a volatility of $1.732\%$ per day). In $t = 10$ days, calculate the expected variance rate??  

We have $\sigma_n^2 = 0.0003$, hence
$$\begin{align*}
\mathbb{E}(\sigma_{n+10}^2 ) = 0.0002075 + 0.993510^{10} × (0.0003 − 0.0002075) = 0.0002942
\end{align*}$$
or the expected volatility per day is $\sqrt{0.0002942} = 1.72\%$, still above the long-term volatility of $1.44\%$ per day.

##  Volatility term structures {.unnumbered}

Suppose it is day $n$. We define
$$V(t) = \mathbb{E}(\sigma_{n+1}^2 )$$
and
$$ a:= \ln \left( \frac{1}{\alpha+\beta} \right) $$
From $\mathbb{E}(\sigma_{n+t}^2) = \sigma^22 + (\alpha + \beta)^t(\sigma_n^2 − \sigma^2)$ we have

$$V(t) = \sigma^2 + e^{−at}(V(0) − \sigma^2)$$
Then we have the average variance rate per day between today and time T.

$$ \frac{1}{T} \int_0^T V(t) \,dt=\frac{1}{T} \int_0^T \left( \sigma^2 + e^{−at}(V(0) − \sigma^2) \right)=\sigma^2+\frac{1-e^{-aT}}{aT} [V(0)-\sigma^2] $$

Now we define $sigma(T)$ the volatility per annum that should be used to price a T-day option under $GARCH(1,1)$ model. Then we have

$$ \sigma^2(T)=252 \left( \sigma^2+\frac{1-e^{-aT}}{aT} [V(0)-\sigma^2] \right) $$
This relationship between the volatility of options and their maturities is referred to as the volatility term structure.

### Example {.unnumbered}

For S&P data, using GARCH(1,1) model we obtain the coefficients $\omega = 0.0000013465$, $\alpha = 0.083394$ and $\beta = b = 0.910116$. So from 
$$ \sigma^2(T)=252 \left( \sigma^2+\frac{1-e^{-aT}}{aT} [V(0)-\sigma^2] \right) $$
assume that $V(0) = 0.0003$ we have
$$ \sigma^2=\frac{0.0000013465}{1 − 0.083394 − 0.910116}=0.0002073 $$
and $a = \ln \left( \frac{1}{0.99351} \right) = 0.00651$. Hence,
$$ \sigma^2(T)=252 \left( 0.0002073+\frac{1-e^{-0.00651 \cdot T}}{0.00651 \cdot T}[0.0003-0.0002073] \right) $$

For the option life (days) T = 10, 30, 50, 100, 500, we obtain the option
volatility ($\%$ per annum)

```{r, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl = "
| Option life (days) | 10 | 30 | 50 | 100 | 500 |
|------|:-----:|------:|------:|------:|------:|
| Option volatility | 27.36 | 27.10 | 26.87 | 26.35 | 24.32 |
"
cat(tabl)
```

# In-class exercise

## Autocovariance

1. Find the autocovariance function of Brownian motion?

>$$\begin{align*}
&B_t \sim \mathcal{N}(0,t) \\
&\rightarrow E[B_t^2] =Var(B_t)=t
\end{align*}$$

>$$\begin{align*}
&B_t-B_{t-\tau} \sim \mathcal{N}(0,t-\tau) \\
&\rightarrow E[(B_t-B_{t-\tau})^2]=Var(B_t-B_{t-\tau})=t-\tau
\end{align*}$$

>$$\begin{align*}
\gamma(t,\tau)&=E[(B_t-\mu_t)(B_{t-\tau}-\mu_{t-\tau})] \\
&=E[B_tB_{t-\tau}] \\
&=-\frac{1}{2}E[(B_t-B_{t-\tau})^2-B_t^2-B_{t-\tau}^2] \\
&=-\frac{1}{2}\{E[(B_t-B_{t-\tau})^2] -E[B_t^2]-E[B_{t-\tau}^2]\} \\
&=-\frac{1}{2} [(\tau)-(t)-(t-\tau)]=t-\tau
\end{align*}$$

>Answer: The autocovariance function of Brownian motion is $t-\tau$

2. Let $cov (X_t,X_{t+h})=\gamma(h)$

### Question a

Prove that $\gamma(h)=\gamma(-h)$

>$$\begin{align*}
\gamma(h)=cov(X_t,X_{t+h}) \\
\rightarrow \gamma(-h)=cov(X_{t},X_{t-h})
\end{align*}$$

>Let $s=t-h$ then $t=s+h$
$$\gamma(-h)=cov(X_{s+h},X_{s})=\gamma(h) $$

### Question b

Prove that $-1 \leq \rho(h) \le1$

>$$\begin{align*}
&\mathbb{E}[(X_{t+h} \pm X_{t})^2] \ge 0 \\ 
&\rightarrow \mathbb{E}[X_{t+h}^2] + \mathbb{E}[X_{t}^2] \pm 2 \mathbb{E}[X_{t+h}X_{t}] \ge 0 \\ 
&\rightarrow 2 \gamma(0) \pm 2\gamma(h) \ge 0 \\ 
&\rightarrow -2 \gamma(0) \leq 2\gamma(h) \leq 2 \gamma(0) \\
&\rightarrow -1 \leq \rho(h) \leq 1
\end{align*}$$

## ADF test

### Python {.unnumbered} 

```{python,warning=FALSE,message=FALSE}
import pandas_datareader as web
import numpy as np
import matplotlib.pyplot as plt

price = web.get_data_yahoo("^gspc",
start = "2009-01-01",
end = "2021-12-31")

# Log-data
x=np.log(price['Adj Close'])
plt.plot(x,color="black")
plt.show()

# First difference of log-data
y=np.diff(np.log(price['Adj Close']))
plt.plot(y,color="black")
plt.show()
```

```{python,warning=FALSE,message=FALSE}
from statsmodels.tsa.stattools import adfuller
result=adfuller(x)
print('ADF Statistic: %f' % result[0])
print('p-value: %f' % result[1])
result=adfuller(y)
print('ADF Statistic: %f' % result[0])
print('p-value: %f' % result[1])
```

### R {.unnumbered} 

```{r,warning=FALSE,message=FALSE}
library(tseries)
library(zoo)
price = get.hist.quote(instrument = "^gspc",start = "2009-01-01",
                       end = ("2021-12-31"),  quote = "AdjClose")
x=coredata(log(price))
y=coredata(diff(log(price)))
# Log-data
ts.plot(x,xlab="time",ylab="returns")
# First difference of log-data
ts.plot(y,xlab="time",ylab="returns")
```

```{r,warning=FALSE,message=FALSE}
library(aTSA)
adf.test(x)
adf.test(y)
```

## KPSS test

### Python {.unnumbered} 

```{python,warning=FALSE,message=FALSE}
import statsmodels.api as sm
#perform KPSS test
result=sm.tsa.stattools.kpss(x)
print('KPSS Statistic: %f' % result[0])
print('p-value: %f' % result[1])
result=sm.tsa.stattools.kpss(y)
print('KPSS Statistic: %f' % result[0])
print('p-value: %f' % result[1])
```

### R {.unnumbered} 

```{r,warning=FALSE,message=FALSE}
library(tseries)
kpss.test(x)
kpss.test(y)
```

## Fit ARIMA 

### Python {.unnumbered} 

```{python,warning=FALSE,message=FALSE}
from statsmodels.tsa.arima.model import ARIMA
model = ARIMA(x, order=(1,0,0))
model_fit = model.fit()
print(model_fit.summary())
model = ARIMA(y, order=(1,0,0))
model_fit = model.fit()
print(model_fit.summary())
```

### R {.unnumbered} 

```{r,warning=FALSE,message=FALSE}
fitAR1=arima(x, order = c(1,0,0))
print(fitAR1)
fitAR2=arima(y, order = c(1,0,0))
print(fitAR2)
```

## What happens with price

### Python {.unnumbered} 

```{python,warning=FALSE,message=FALSE}
from statsmodels.tsa.arima.model import ARIMA
from statsmodels.tsa.stattools import adfuller
import statsmodels.api as sm
#what happens if we fit AR for price, not that price is non-stationary
fitAR=ARIMA(price['Adj Close'], order=(1,0,0))
print(fitAR)
result=adfuller(price['Adj Close'])
print('ADF Statistic: %f' % result[0])
print('p-value: %f' % result[1])
result=sm.tsa.stattools.kpss(price['Adj Close'])
print('KPSS Statistic: %f' % result[0])
print('p-value: %f' % result[1])
```

### R {.unnumbered} 

```{r,warning=FALSE,message=FALSE}
library(tseries)
library(zoo)
#what happens if we fit AR for price, not that price is non-stationary
fitAR=arima(price$Adjusted, order = c(1,0,0))
print(fitAR)
adf.test(coredata(price))
kpss.test(coredata(price))
```

# Homework

## Problem 1 {.unnumbered} 

Give the data

```{r, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl = "
| Time  | Data  | Time  | Data  | Time | Data |
|------:|:-----:|------:|------:|-----:|-----:|
| 1 | 10.31778 | 7 | 10.36644 | 13 | 10.34145 |
| 2 | 10.29235 | 8 | 10.36744 | 14 | 10.40247 |
| 3 | 10.30075 | 9 | 10.39553 | 15 | 10.39158 |
| 4 | 10.29208 | 10 | 10.48562 | 16 | 10.35517 |
| 5 | 10.31304 | 11 | 10.47619 | 17 | 10.35166 |
| 6 | 10.32042 | 12 | 10.46396 | 18 | 10.36395 |
"
cat(tabl)
```

Calculate the ACF with lags from 0 to 15 and lower, upper bounds with significant α = 5%

### Python {.unnumbered}  

```{python,warning=FALSE,message=FALSE}
import numpy as np
import warnings
warnings.filterwarnings("ignore")

# Import Data
data = [10.31778, 10.29235, 10.30075, 10.29208, 10.31304, 10.32042,
        10.36644, 10.36744, 10.39553, 10.48562, 10.47619, 10.46396,
        10.34145, 10.40247, 10.39158, 10.35517, 10.35166, 10.36395]

import pandas as pd
df = pd.DataFrame(data, columns = ['data'])
df.head(5)

from statsmodels.tsa.stattools import acf
# Calculate ACF
print('Calculated ACF by lags 0 - 15:\n')
acf(df['data'], nlags = 15)

import matplotlib.pyplot as plt
from statsmodels.graphics.tsaplots import plot_acf
plot_acf(df['data'], lags = 15)
plt.show()
```

### R {.unnumbered}  

```{r,warning=FALSE,message=FALSE}
# Import Data
data = c(10.31778, 10.29235, 10.30075, 10.29208, 10.31304, 10.32042,
        10.36644, 10.36744, 10.39553, 10.48562, 10.47619, 10.46396,
        10.34145, 10.40247, 10.39158, 10.35517, 10.35166, 10.36395)
```

```{r,warning=FALSE,message=FALSE}
head(data)
```

```{r,warning=FALSE,message=FALSE}
# Calculate ACF
acf(data,lag.max = 15,plot=F)
```

```{r,warning=FALSE,message=FALSE}
# Plot ACF
acf(data,lag.max = 15)
```

## Problem 2 {.unnumbered} 

Consider the $MA(q)$. 

### Question a {.unnumbered} 

Calculate autocovariance $\gamma(h)$ and ACF $\rho(h)$.

>Note that MA(q) is stationary since it is a linear combination of stationary
processes. Note that, white noise has
$$\gamma(0)=Cov(\epsilon_t,\epsilon_{t})=\sigma^2 $$ 
and $ \gamma(h)=0 $ if $h \neq 0$. For more simple we assume that $E[X_t] = 0$. So we have the
autocovariance is

>$$\begin{align*}
\gamma(h) &= Cov(X_t,X_{t+h}) \\
&=Cov(\sum_{i=1}^q \theta_i \epsilon_{t-i},\sum_{j=1}^q \theta_j \epsilon_{t+h-j}) \\
&= \sum_{i=1}^q \sum_{j=1}^q \theta_i \theta_j Cov(\epsilon_{t-i},\epsilon_{t+h-j}) \\
&= \sum_{i=0}^{q-|h|} \theta_i \theta_{i+|h|}\sigma^2, |h| \leq q
\end{align*}$$
Hence,
$$ \rho(h) = \frac{\sum_{i=0}^{q-|h|} \theta_i \theta_{i+|h|}\sigma^2}{\sum_{i=0}^{q}\theta_i^2} $$ and $\rho(h)=0$ for $|h| > q$

### Question b {.unnumbered} 
  
Show that the MA(1) processes $X_t$ and $Y_t$
$$\begin{align*}
X_t = \beta \epsilon_{t−1} + \epsilon_t \\ 
Y_t = \frac{1}{\beta} \epsilon_{t−1} + \epsilon_t \\ 
\end{align*}$$
have the same ACF.

>Consider the $MA(1)$ model $X_t=\beta \epsilon_{t-1}+\epsilon_t$. The coefficient $\theta_1=\beta$. The ACF is given by
$$ \rho_1=\frac{\beta}{1+\beta^2}, (1) $$
and $\rho_h=0, \forall h \geq 2$ 

>Consider the $MA(1)$ model $Y_t=\frac{1}{\beta} \epsilon_{t-1}+\epsilon_t$. The coefficient $\theta_1=\frac{1}{\beta}$. The ACF is given by
$$\begin{align*} \rho_1&=\frac{\frac{1}{\beta}}{1+\left(\frac{1}{\beta}\right)^2} \\
&=\frac{1}{\beta} \cdot \frac{\beta^2}{1+\beta^2} \\
&=\frac{\beta}{1+\beta^2}, (2) 
\end{align*}$$
and $\rho_h=0, \forall h \geq 2$ 

>(1),(2) imply two $MA(1)$ processes above have the same ACF.

>Answer: $X_t$ and $Y_t$ have the same ACF.

## Problem 3 {.unnumbered} 

Suppose that the stationary process $X_t$ has an autocovariance function given by $\gamma(h)$.
Consider process $Y_t = X_t − X_{t−1}$.

a) Is the process $Y_t$ stationary

>
$$\begin{align*}
\mathbb{E}(Y_t)&=\mathbb{E}(X_t)-\mathbb{E}(X_{t-1}) \\
&=0 \\
Var(Y_t) &=Var(X_t-X_{t=1}) \\
&=Var(X_t)+Var(X_{t-1})-2Cov(X_t,X_{t-1}) \\
&=2\sigma_x^2-2\gamma_x(1) < \infty \\
Cov(Y_t,Y_{t+h})&=Cov(X_t-X_{t-1},X_{t+h}-X_{t+h-1}) \\
&=Cov(X_t,X_{t+h}) 
-Cov(X_t,X_{t+h-1}) 
-Cov(X_{t-1},X_{t+h})
+Cov(X_{t-1},X_{t+h-1}) \\
&=\gamma(h)-\gamma(h-1)-\gamma(h+1)+\gamma(h) \\
&=2\gamma(h)-\gamma(h-1)-\gamma(h+1)
\end{align*}$$

>Answer: $\{Yt\}$ is a weakly stationary proces

b) Find the autocorrelation function of $Y_t$

>
$$\begin{align*}
\rho(h)&=\rho_h(Y_t) \\
&=\frac{\gamma(h)}{\gamma(0)} \\
&=\frac{2\gamma(h)-\gamma(h-1)-\gamma(h+1)}{2 (\gamma(0)-\gamma(1))} 
\end{align*}$$

>Answer: The autocorrelation function of $Y_t$ is $\frac{2\gamma(h)-\gamma(h-1)-\gamma(h+1)}{2 (\gamma(0)-\gamma(1))}$

## Problem 4 {.unnumbered} 

Find the autocorrelation function of the second order moving average process $MA(2)$
$$X_t = 0.5 \epsilon_{t−1} − 0.2 \epsilon_{t−2} + \epsilon_t$$
where $\epsilon_t$ is the white noise.

>Apply problem $2$ with $q=2$, we have
$$ \gamma(h)=\sum_{i=0}^{2-|h|}\theta_i \theta_{i+|h|}\sigma^2, |h| \leq 2 $$
Hence,
$$\begin{align*}
\gamma(0) &= (\theta_0^2 + \theta_1^2 + \theta_2^2) \sigma^2 \\
&=(0.5^2 + 0.2^2 +1)\sigma^2 \\
&=1.29 \sigma^2 \\
\gamma(1) &= (\theta_0 \theta_1 + \theta_1 \theta_2) \sigma^2 \\
&=(1 \cdot 0.5   - 0.5 \cdot 0.2 )\sigma^2 \\
&=0.4 \sigma^2 \\
\gamma(2) &= \theta_0 \theta_2 \sigma^2 \\
&=-0.2 \sigma^2 \\
\end{align*}$$

>
$$\begin{align*}
\gamma(0)&=Var(X_t) \\
&=0.5^2 \sigma^2 +0.2^2 \sigma^2+\sigma^2 \\
&=(0.5^2 + 0.2^2 +1)\sigma^2 \\
&=1.29 \sigma^2 \\
\gamma(1) &=Cov(X_t,X_{t-1}) \\
&=Cov(0.5 \epsilon_{t-1} - 0.2 \epsilon_{t-2}+\epsilon_t,0.5 \epsilon_{t-2} -0.2\epsilon_{t-3}+\epsilon_{t-1}) \\
&=0.5 \cdot 1 Var(\epsilon_{t-1})-0.2 \cdot 0.5 Var(\epsilon_{t-2}) \\
&=(0.5 \cdot 1 -0.2 \cdot 0.5)\sigma^2 \\
&=0.4 \sigma^2 \\
\gamma(2) &=Cov(X_t,X_{t-2}) \\
&=Cov(0.5 \epsilon_{t-1} - 0.2 \epsilon_{t-2}+\epsilon_t,0.5 \epsilon_{t-3} -0.2\epsilon_{t-4}+\epsilon_{t-2}) \\
&=-0.2\cdot 1Var(\epsilon_{t-2}) \\
&=-0.2 \sigma^2
\end{align*}$$

>$$\rho(h)=\begin{cases}
    1&  h=0.\\
    0.31&  h=1\\
    -0.155&  h=2 \\
    0&  h \geq 3
  \end{cases}$$
  
>Answer: The autocorrelation function of the second order moving average process is
$$\rho(h)=\begin{cases}
    1&  h=0.\\
    0.31&  h=1\\
    -0.155&  h=2 \\
    0&  h \geq 3
  \end{cases}$$
  
## Problem 5 {.unnumbered} 

Assume that the price of an asset at close of trading yesterday was \$300 and its volatility was estimated as 1.3\% per day. The price at the close of trading today is \$298. Update the volatility estimate by using the following methods:

### Question a {.unnumbered} 

EWMA with $\lambda=0.94$.

>$$\begin{align*}
\widehat{\sigma}_t^2 &=\lambda\cdot\widehat{\sigma}_{t-1}^2+(1-\lambda)\cdot y_{t-1}^2 \\
&=0.94\cdot0.013^2+0.06\cdot\left( \ln \frac{298}{300}\right)^2 \\
&\approx1.6153\cdot10^{-4} \\
\rightarrow \widehat{\sigma}_t &\approx0.0127
\end{align*}$$

>Answer: The volatility estimate by using the EWMA with $\lambda=0.94$ is $1.27\%$.

### Question b {.unnumbered} 

The GARCH$(1,1)$ model with $\omega=2\cdot10^{-6},\alpha=0.04,\beta=0.94$.

>$$\begin{align*}
\widehat{\sigma}_t^2 &=\omega+\alpha\cdot y_{t-1}^2+\beta\cdot\widehat{\sigma}_{t-1}^2 \\
&=2\cdot10^{-6}+0.04\cdot\left( \ln \frac{300}{298}\right)^2+0.94\cdot0.013^2 \\
&\approx1.6265\cdot10^{-4} \\
\rightarrow \widehat{\sigma}_t &\approx0.0128
\end{align*}$$
    
>Answer: The volatility estimate by using the GARCH$(1,1)$ model with the given parameters is $1.28\%$.

## Problem 6 {.unnumbered} 

Suppose that the parameters in a GARCH$(1,1)$ model are $\alpha=0.03,\beta=0.95,\omega=2\cdot10^{-6}.$

### Question a {.unnumbered} 

What is the long-run average volatility?

>The long-run average volatility is
>$$\begin{align*}
\sigma &=\sqrt{\frac{\omega}{1-\alpha-\beta}} \\
&=\sqrt{\frac{2\cdot10^{-6}}{1-0.03-0.95}} \\
&=0.01
\end{align*}$$

>Answer: The long-run average volatility is $1\%$.
    
### Question b {.unnumbered} 

If the current volatility is $1.5\%$ per day, what is the estimate of the volatility in $20$, $40$, and $60$ days?

>The estimate of the volatility in $20$ days is:
$$\begin{align*}
\mathbb{E}(\sigma_{n+20}^2) &=\sigma^2+(\alpha+\beta)^{20}\cdot(\sigma_n^2-\sigma^2) \\
&=0.01^2+(0.03+0.95)^{20}\cdot(0.015^2-0.01^2) \\
&\approx1.8345\cdot10^{-4} \\
\rightarrow \sigma_{n+20}&\approx0.0135 \\
\end{align*}$$

>The estimate of the volatility in $40$ days is:
$$\begin{align*}
\mathbb{E}(\sigma_{n+40}^2) &=\sigma^2+(\alpha+\beta)^{40}\cdot(\sigma_n^2-\sigma^2) \\
&=0.01^2+(0.03+0.95)^{40}\cdot(0.015^2-0.01^2) \\
&\approx1.5571\cdot10^{-4} \\
\rightarrow \sigma_{n+40}&\approx0.0125 \\
\end{align*}$$

>The estimate of the volatility in $60$ days is:
$$\begin{align*}
\mathbb{E}(\sigma_{n+60}^2) &=\sigma^2+(\alpha+\beta)^{60}\cdot(\sigma_n^2-\sigma^2) \\
&=0.01^2+(0.03+0.95)^{60}\cdot(0.015^2-0.01^2) \\
&\approx1.3719\cdot10^{-4} \\
\rightarrow \sigma_{n+60}&\approx0.0117 \\
\end{align*}$$

>Answer: If the current volatility is $1.5\%$ per day, the estimates of the volatility in $20$, $40$, and $60$ days are $1.35\%$, $1.25\%$ and $1.17\%$, respectively.
    
### Question c {.unnumbered} 

What volatility should be used to price $20$, $40$, and $60$-day  options?

With the current volatility being $1.5\%$ per day, we have

>$$\begin{align*}
a &=\ln\frac{1}{\alpha+\beta} \\
&=\ln\frac{1}{0.03+0.95} \\
&\approx0.0202
\end{align*}$$

>The volatility should be used to price $20$-day  options:
$$\begin{align*}
\sigma^2(20) &=252\cdot\left(\sigma^2+\frac{1-e^{-20a}}{20a}\cdot(\sigma_{n}^2-\sigma^2)\right) \\
&= 252\cdot\left(0.01^2+\frac{1-e^{-20\cdot0.0202}}{20\cdot0.0202}\cdot(0.015^2-0.01^2)\right)\\
&\approx0.0511 \\
\rightarrow\sigma(20) &\approx0.2261
\end{align*}$$

>The volatility should be used to price $40$-day  options:
$$\begin{align*}
\sigma^2(40) &=252\cdot\left(\sigma^2+\frac{1-e^{-40a}}{40a}\cdot(\sigma_{n}^2-\sigma^2)\right) \\
&= 252\cdot\left(0.01^2+\frac{1-e^{-40\cdot0.0202}}{40\cdot0.0202}\cdot(0.015^2-0.01^2)\right)\\
&\approx0.0468 \\
\rightarrow\sigma(40) &\approx0.2164
\end{align*}$$

>The volatility should be used to price $60$-day  options:
$$\begin{align*}
\sigma^2(60) &=252\cdot\left(\sigma^2+\frac{1-e^{-60a}}{60a}\cdot(\sigma_{n}^2-\sigma^2)\right) \\
&= 252\cdot\left(0.01^2+\frac{1-e^{-60\cdot0.0202}}{60\cdot0.0202}\cdot(0.015^2-0.01^2)\right)\\
&\approx0.0435 \\
\rightarrow\sigma(60) &\approx0.2085
\end{align*}$$

>Answer: The volatility should be used to price $20$, $40$ and $60$-day options are $22.61\%$, $21.64\%$ and $20.85\%$, respectively.

### Question d {.unnumbered} 

Suppose that there is an event that increases the volatility from $1.5%$ per day to $2%$ per day. Estimate the effect on the volatility in $20$, $40$, and $60$ days.

>The estimate of the volatility in $20$ days is:
$$\begin{align*}
\mathbb{E}(\sigma_{n+20}^2) &=\sigma^2+(\alpha+\beta)^{20}\cdot(\sigma_n^2-\sigma^2) \\
&=0.01^2+(0.03+0.95)^{20}\cdot(0.02^2-0.01^2) \\
&\approx3.0028\cdot10^{-4} \\
\rightarrow \sigma_{n+20}&\approx 0.0173 \\
\end{align*}$$

>The estimate of the volatility in $40$ days is:
$$\begin{align*}
\mathbb{E}(\sigma_{n+40}^2) &=\sigma^2+(\alpha+\beta)^{40}\cdot(\sigma_n^2-\sigma^2) \\
&=0.01^2+(0.03+0.95)^{40}\cdot(0.02^2-0.01^2) \\
&\approx2.3371\cdot10^{-4} \\
\rightarrow \sigma_{n+40}&\approx 0.0153\\
\end{align*}$$

>The estimate of the volatility in $60$ days is:
$$\begin{align*}
\mathbb{E}(\sigma_{n+60}^2) &=\sigma^2+(\alpha+\beta)^{60}\cdot(\sigma_n^2-\sigma^2) \\
&=0.01^2+(0.03+0.95)^{60}\cdot(0.02^2-0.01^2) \\
&\approx1.8927\cdot10^{-4} \\
\rightarrow \sigma_{n+60}&\approx 0.0138\\
\end{align*}$$

><ul>If the current volatility is $1.5\%$ per day, the estimates of the volatility in $20$, $40$, and $60$ days are $0.0135$, $0.0125$ and $0.0117$, respectively.</ul>
<ul>If the current volatility is $2\%$ per day, the estimates of the volatility in $20$, $40$, and $60$ days are $0.0173$, $0.0153$ and $0.0138$, respectively.</ul>
Therefore, the volatility in $20$, $40$ and $60$ days increases respectively by 
$$\frac{0.0173}{0.0135}-1\approx0.2814 \\
\frac{0.0153}{0.0125}-1\approx0.2240 \\
\frac{0.0138}{0.0117}-1\approx0.1795$$

>Answer: If there is an event that increases the volatility from $1.5%$ per day to $2%$ per day, the volatility in $20$, $40$ and $60$ days increases by $28.14\%$, $22.4\%$ and $17.95\%$, respectively.
    
### Question e {.unnumbered} 

Estimate by how much the event increases the volatilities used to price $20$, $40$, and $60$-day  options.

With the current volatility being $2\%$ per day, we have

>$$\begin{align*}
a &=\ln\frac{1}{\alpha+\beta} \\
&=\ln\frac{1}{0.03+0.95} \\
&\approx0.0202
\end{align*}$$

>The volatility should be used to price $20$-day  options:
$$\begin{align*}
\sigma^2(20) &=252\cdot\left(\sigma^2+\frac{1-e^{-20a}}{20a}\cdot(\sigma_{n}^2-\sigma^2)\right) \\
&= 252\cdot\left(0.01^2+\frac{1-e^{-20\cdot0.0202}}{20\cdot0.0202}\cdot(0.02^2-0.01^2)\right)\\
&\approx0.0874 \\
\rightarrow\sigma(20) &\approx0.2956
\end{align*}$$

>The volatility should be used to price $40$-day  options:
$$\begin{align*}
\sigma^2(40) &=252\cdot\left(\sigma^2+\frac{1-e^{-40a}}{40a}\cdot(\sigma_{n}^2-\sigma^2)\right) \\
&= 252\cdot\left(0.01^2+\frac{1-e^{-40\cdot0.0202}}{40\cdot0.0202}\cdot(0.02^2-0.01^2)\right)\\
&\approx0.0771 \\
\rightarrow\sigma(40) &\approx0.2776
\end{align*}$$

>The volatility should be used to price $60$-day  options:
$$\begin{align*}
\sigma^2(60) &=252\cdot\left(\sigma^2+\frac{1-e^{-60a}}{60a}\cdot(\sigma_{n}^2-\sigma^2)\right) \\
&= 252\cdot\left(0.01^2+\frac{1-e^{-60\cdot0.0202}}{60\cdot0.0202}\cdot(0.02^2-0.01^2)\right)\\
&\approx0.0690 \\
\rightarrow\sigma(60) &\approx0.2627
\end{align*}$$

><ul>If the current volatility is $1.5\%$ per day, the volatility should be used to price $20$, $40$ and $60$-day options are $0.2261$, $0.2164$ and $0.2085$, respectively.</ul>
<ul>If the current volatility is $2\%$ per day, the volatility should be used to price $20$, $40$ and $60$-day options are $0.2956$, $0.2776$ and $0.2627$, respectively.</ul>
Therefore, if there is an event that increases the volatility from $1.5%$ per day to $2%$ per day, the volatilities used to price increase by
$$\frac{0.2956}{0.2261}-1\approx0.3074 \\
\frac{0.2776}{0.2164}-1\approx0.2828 \\
\frac{0.2627}{0.2085}-1\approx0.2600$$

>Answer: If there is an event that increases the volatility from $1.5%$ per day to $2%$ per day, the volatilities used to price increase by $30.74\%$, $28.28\%$ and $26\%$, respectively.

## Problem 7 {.unnumbered} 

Consider ARCH$(1)$ process, show that
$$\mathbb{E}(\sigma_{t+s}^2|\mathcal{F}_t)=\frac{1-\alpha^s}{1-\alpha}\cdot\omega+\alpha^s\cdot\sigma_t^2,\forall s\geq1$$

>Consider the following ARCH$(1)$ process:
$$\sigma_{t+1}^2=\omega+\alpha \sigma_t^2\epsilon_t^2$$
We will prove the assertion
$$\mathbb{E}(\sigma_{t+s}^2|\mathcal{F}_t)=\frac{1-\alpha^s}{1-\alpha}\cdot\omega+\alpha^s\sigma_t^2,\forall s\geq1$$ 
by induction on $s$. 

>For $s=1$:
$$\begin{align*}
\mathbb{E}(\sigma_{t+1}^2|\mathcal{F}_t) &=\mathbb{E}(\omega+\alpha \sigma_t^2\epsilon_t^2|\mathcal{F}_t) \\
&=\mathbb{E}(\omega+\alpha \sigma_t^2\epsilon_t^2) \\
&=\mathbb{E}(\omega)+\mathbb{E}(\alpha \sigma_t^2\epsilon_t^2) \\
&=\omega+\alpha \sigma_t^2\mathbb{E}(\epsilon_t^2) \\
&=\frac{1-\alpha^1}{1-\alpha}\cdot\omega+\alpha \sigma_t^2
\end{align*}$$
    
>Assume the assertion holds for some $k\in\mathbb{N}$. That is:
$$\begin{align*}
    \mathbb{E}(\sigma_{t+k+1}^2|\mathcal{F}_t) &= \mathbb{E}(\mathbb{E}(\sigma_{t+k+1}^2|\mathcal{F}_{t+1})|\mathcal{F}_t) \\
    &=\mathbb{E}\left(\left.\frac{1-\alpha^k}{1-\alpha}\cdot\omega+\alpha^k\sigma_{t+1}^2\right|\mathcal{F}_t\right)\\
    &= \frac{1-\alpha^k}{1-\alpha}\cdot\omega+\alpha^k\mathbb{E}(\sigma_{t+1}^2|\mathcal{F}_t) \\
    &=\frac{1-\alpha^k}{1-\alpha}\cdot\omega+\alpha^k(\omega+\alpha \sigma_t^2)\\
    &= \left(\frac{1-\alpha^k}{1-\alpha}+\alpha^k\right)\cdot\omega+\alpha^{k+1}\sigma_t^2 \\
    &=\frac{1-\alpha^{k+1}}{1-\alpha}\cdot\omega+\alpha^{k+1}\sigma_t^2
\end{align*}$$

>Therefore, the assertion holds $\forall s\geq1$. 

## Problem 8 {.unnumbered} 

### Python {.unnumbered}

We can download the SP500 data from internet by using Python.

```{python,warning=F,message=F}
import pandas_datareader as web
price = web.get_data_yahoo("^GSPC",
                           start = "2009-01-01",
                           end ="2021-12-31")
```

### Question a {.unnumbered} 

Denote $y$ the returns of SP500. Plot the returns and calculate statistical characterizations of returns (e.g., min, max, sd, skewness, kurtosis, acf), use Jarque Berra test, Box test.

```{python,warning=F,message=F}
# Calculate returns y
import numpy as np
y = np.diff(np.log(price['Adj Close']))
```

```{python,warning=F,message=F}
# Plot the returns
import matplotlib.pyplot as plt
plt.plot(y)
plt.show()
```

```{python,warning=F,message=F}
# Statistical characterizations of returns
from scipy.stats import describe
describe(y)
```

```{python,warning=F,message=F}
# Autocorrelation function
from statsmodels.tsa.stattools import acf
acf(y)
```

```{python,warning=F,message=F}
# Plot ACF of the returns
import matplotlib.pyplot as plt
from statsmodels.graphics.tsaplots import plot_acf
plot_acf(y)
plt.show()
```

```{python,warning=F,message=F}
# Jarque Berra test
import scipy.stats as stats
stats.jarque_bera(y)
```

```{python,warning=F,message=F}
# Box test
from statsmodels.stats.diagnostic import acorr_ljungbox
acorr_ljungbox(y)
```
    
### Question b {.unnumbered} 

Use ADF test for the prices and returns to see which series is stationary.

```{python,warning=F,message=F}
# Plot price
import matplotlib.pyplot as plt
plt.plot(price['Adj Close'])
plt.show()
```

```{python,warning=F,message=F}
# ADF test for prices
from statsmodels.tsa.stattools import adfuller
result = adfuller(price['Adj Close'])
print('p-value: %f' % result[1])
```

```{python,warning=F,message=F}
# Plot the returns
import matplotlib.pyplot as plt
plt.plot(y)
plt.show()
```

```{python,warning=F,message=F}
# ADF test for returns
from statsmodels.tsa.stattools import adfuller
result = adfuller(y)
print('p-value: %f' % result[1])
```

### Question c {.unnumbered} 

Using AR$(1)$ to fit the price and returns y and find the coefficients of these fitted AR$(1)$ model. 

```{python,warning=F,message=F}
# Using AR(1) to fit the price
import statsmodels
from statsmodels.tsa.arima.model import ARIMA
ar1_price = ARIMA(price['Adj Close'], 
                  order = (1, 0, 0)).fit()
print(ar1_price.summary())
```

```{python,warning=F,message=F}
# Find the coefficients of the fitted AR(1) model
ar1_price.params[0:2]
```

```{python,warning=F,message=F}
# Using AR(1) to fit the returns
import statsmodels
from statsmodels.tsa.arima.model import ARIMA
ar1_y = ARIMA(y, 
              order = (1, 0, 0)).fit()
print(ar1_y.summary())
```

```{python,warning=F,message=F}
# Find the coefficients of the fitted AR(1) model
ar1_y.params[0:2]
```

Note that If the residuals have a mean other than zero, then the forecasts are biased. Now using this fact you can check the mean of residuals of AR$(1)$ for price and return to see that you can not apply AR$(1)$ directly for price. 

```{python,warning=F,message=F}
# Check the mean of residuals
ar1_price.resid[1:].mean()
```

```{python,warning=F,message=F}
# Check the mean of residuals
ar1_y.resid[1:].mean()
```

Check independence of residuals fitted AR$(1)$, are they independence or not?

```{python,warning=F,message=F}
# Plot ACF of residuals
import matplotlib.pyplot as plt
from statsmodels.graphics.tsaplots import plot_acf
plot_acf(ar1_y.resid)
plt.show()
```

ACF are significant in many lags so the residuals of AR$(1)$ of the returns is correlated and thus is not independence.

### Question d {.unnumbered} 

Fit the returns by ARMA$(3,3)$, compare with AR$(1)$ above, can you conclude that
ARMA$(3,3)$ is better than AR$(1)$?

```{python,warning=F,message=F}
# Fit the returns by ARMA(3,3)
import statsmodels
from statsmodels.tsa.arima.model import ARIMA
arma33_y = ARIMA(y, 
                 order = (3, 0, 3)).fit()
print(arma33_y.summary())
```

AIC from ARMA$(3,3)$ is less than AIC from AR$(1)$ so we can conclude that ARMA$(3,3)$ is better than AR$(1)$.

### Question e {.unnumbered} 

Use ARCH$(1)$, GARCH$(1,1)$ and t-GARCH$(1,1)$ to fit the
volatility of the returns and then give your conclusions.

```{python,warning=F,message=F}
# ARCH(1)
import arch
from arch import arch_model
arch_fit = arch_model(y, mean = 'Zero', 
                         vol = 'ARCH', 
                         q = 1).fit()
print(arch_fit.summary())
```

```{python,warning=F,message=F}
# GARCH(1,1)
import arch
from arch import arch_model
garch_fit = arch_model(y, 
                       mean = 'Zero', 
                       vol = 'GARCH',
                       p = 1, 
                       q = 1).fit()
print(garch_fit.summary())
```

```{python,warning=F,message=F}
# t-GARCH(1,1)
import arch
from arch import arch_model
tgarch_fit = arch_model(y, 
                        mean = 'Zero', 
                        vol = 'GARCH',
                        p = 1, 
                        q = 1, 
                        dist = 'StudentsT').fit()
print(tgarch_fit.summary())
```

AIC from t-GARCH$(1,1)$ is the smallest so we can conclude that t-GARCH$(1,1)$ is the best model.

### R {.unnumbered}

We can download the SP500 data from internet by using R.

```{r,warning=F,message=F}
library(tseries)
library(zoo)
price = get.hist.quote(instrument = "^gspc",
                       start = "2009-01-01",
                       end = ("2021-12-31"),  
                       quote = "AdjClose")
```

### Question a {.unnumbered} 

Denote $y$ the returns of SP500. Plot the returns and calculate statistical characterizations of returns (e.g., min, max, sd, skewness, kurtosis, acf), use Jarque Berra test, Box test.

```{r,warning=F,message=F}
# Calculate returns y
library(tidyverse)
y = price %>% 
  log %>% 
  diff
```

```{r,warning=F,message=F}
# Plot the returns
y %>% 
  plot
```

```{r,warning=F,message=F}
# Statistical characterizations of returns
library(psych)
y %>% 
  describe %>% 
  select(min,
         max,
         sd,
         skew,
         kurtosis)
```

```{r,warning=F,message=F}
# Plot ACF of the returns
y %>% 
  coredata %>% 
  acf
```

```{r,warning=F,message=F}
# Jarque Berra test
library(moments)
y %>% 
  coredata %>% 
  c %>% 
  jarque.test
```

```{r,warning=F,message=F}
# Box test
library(stats)
y %>% 
  Box.test(lag = 10, 
           type = "Ljung-Box")
```
    
### Question b {.unnumbered} 

Use ADF test for the prices and returns to see which series is stationary.

```{r,warning=F,message=F}
# Plot price
price %>% 
  plot
```

```{r,warning=F,message=F}
# ADF test for prices
library(tseries)
price %>% 
  coredata %>%
  adf.test
```

```{r,warning=F,message=F}
# Plot the returns
y %>% 
  plot
```

```{r,warning=F,message=F}
# ADF test for returns
library(tseries)
y %>% 
  coredata %>%
  adf.test
```

### Question c {.unnumbered} 

Using AR$(1)$ to fit the price and returns y and find the coefficients of these fitted AR$(1)$ model. 

```{r,warning=F,message=F}
# Using AR(1) to fit the price
library(stats)
ar1_price = price %>%
  arima(c(1,0,0))
```

```{r,warning=F,message=F}
# Find the coefficients of the fitted AR(1) model
ar1_price %>%
  coefficients
```

```{r,warning=F,message=F}
# Using AR(1) to fit the returns
library(stats)
ar1_y = y %>% 
  arima(c(1,0,0))
```

```{r,warning=F,message=F}
# Find the coefficients of the fitted AR(1) model
ar1_y %>% 
  coefficients
```

Note that If the residuals have a mean other than zero, then the forecasts are biased. Now using this fact you can check the mean of residuals of AR$(1)$ for price and return to see that you can not apply AR$(1)$ directly for price. 

```{r,warning=F,message=F}
# Check the mean of residuals
ar1_price %>% 
  residuals %>% 
  coredata %>% 
  na.omit %>% 
  mean
```

```{r,warning=F,message=F}
# Check the mean of residuals
ar1_y %>% 
  residuals %>% 
  coredata %>% 
  na.omit %>% 
  mean
```

Check independence of residuals fitted AR$(1)$, are they independence or not?

```{r,warning=F,message=F}
# Plot ACF of the residuals
library(stats)
ar1_y %>% 
  residuals %>% 
  coredata %>% 
  na.omit %>% 
  acf
```

ACF are significant in many lags so the residuals of AR$(1)$ of the returns is correlated and thus is not independence.

### Question d {.unnumbered} 

Fit the returns by ARMA$(3,3)$, compare with AR$(1)$ above, can you conclude that
ARMA$(3,3)$ is better than AR$(1)$?

```{r,warning=F,message=F}
# Fit the returns by ARMA(3,3)
library(stats)
arma33_y = y %>%
  arima(c(3,0,3))
arma33_y$aic < ar1_y$aic
```

AIC from ARMA$(3,3)$ is less than AIC from AR$(1)$ so we can conclude that ARMA$(3,3)$ is better than AR$(1)$.

### Question e {.unnumbered} 

Use ARCH$(1)$, GARCH$(1,1)$ and t-GARCH$(1,1)$ (using package rugarch) to fit the
volatility of the returns and then give your conclusions.

```{r,warning=F,message=F}
# ARCH(1)
library(fGarch)
arch.fit = garchFit(~garch(1,0), data = y, trace = F)
summary(arch.fit)
```

```{r,warning=F,message=F}
# GARCH(1,1)
library(rugarch)
garch_spec = ugarchspec(variance.model = list(model = "sGARCH",
                                           garchOrder = c(1,1)),
                       mean.model = list(armaOrder = c(0,0),
                                       include.mean = T,
                                       distribution.model = "norm"))
garch_fit = ugarchfit(garch_spec, y %>% coredata %>% c)
garch_fit
```

```{r,warning=F,message=F}
# TGARCH(1,1)
library(rugarch)
tgarch_spec = ugarchspec(variance.model = list(model = "sGARCH",
                                           garchOrder = c(1,1)),
                       mean.model = list(armaOrder = c(0,0),
                                       include.mean = T,
                                       distribution.model = "std"))
tgarch_fit = ugarchfit(tgarch_spec, y %>% coredata %>% c)
tgarch_fit
```

AIC from t-GARCH$(1,1)$ is the smallest so we can conclude that t-GARCH$(1,1)$ is the best model.